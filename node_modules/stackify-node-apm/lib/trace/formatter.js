'use strict'

const os = require('os')
const path = require('path')
const process = require('process')
const URL = require('url')

const _traceSource = 'NODEJS'
const _traceTarget = 'RETRACE'
const _traceVersion = '2.0'
const _hostname = os.hostname()
const _osType = os.type()

/**
 * Handles formatting of transaction objects prior to submitting to Agent.
 * @constructor
 */
function TraceFormatter () {
}

/**
 * Process and format transaction.
 * @param transaction
 * @returns JSON trace
 */
TraceFormatter.prototype.formatTransaction = function (transaction) {
  // exclude any private members
  function replacer (key, value) {
    if (key && key.startsWith('_')) {
      return undefined
    } else {
      return value
    }
  }

  this._processSpan(transaction.rootSpan)

  return JSON.stringify(transaction.rootSpan, replacer)
}

/**
 * Processing for span and all children spans; adds in missing properties.
 * @param span
 * @private
 */
TraceFormatter.prototype._processSpan = function (span) {
  if (span) {
    if (span === span.getTransaction().rootSpan) {
      // determine REPORTING_URL if not present
      if (!span.props['REPORTING_URL']) {
        let reportingURL = null
        if (span.props['URL']) {
          const url = URL.parse(span.props['URL'])
          if (url) {
            reportingURL = url.pathname
          }
        }
        if (!reportingURL || reportingURL === '') {
          reportingURL = '/'
        }
        span.addProperty('REPORTING_URL', reportingURL)
      }

      span.addProperty('APPLICATION_PATH', '/')
      span.addProperty('APPLICATION_FILESYSTEM_PATH', path.dirname(require.main.filename))
      span.addProperty('APPLICATION_NAME', span.getTransaction().getConfiguration().applicationName)
      span.addProperty('APPLICATION_ENV', span.getTransaction().getConfiguration().environmentName)
      span.addProperty('THREADID', process.pid)
      span.addProperty('TRACETYPE', 'WEBAPP')
      span.addProperty('TRACE_ID', span.getTransaction().id())
      span.addProperty('TRACE_SOURCE', _traceSource)
      span.addProperty('TRACE_TARGET', _traceTarget)
      span.addProperty('HOST_NAME', _hostname)
      span.addProperty('OS_TYPE', _osType)
      span.addProperty('PROCESS_ID', process.pid)
      span.addProperty('TRACE_VERSION', _traceVersion)

      return
    }

    // process children
    if (span.stacks) {
      for (let i = 0; i < span.stacks.length; i++) {
        this._processSpan(span.stacks[i])
      }
    }
  }
}

module.exports = TraceFormatter
